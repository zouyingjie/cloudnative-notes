<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-rc.0">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>容器基础技术：namespace | 云原生架构笔记</title><meta name="description" content="构建大规模高可用的分布式系统">
    <link rel="preload" href="/cloudnativenotes/assets/style-C8UjLoOj.css" as="style"><link rel="stylesheet" href="/cloudnativenotes/assets/style-C8UjLoOj.css">
    <link rel="modulepreload" href="/cloudnativenotes/assets/app-C-eiXR-Q.js"><link rel="modulepreload" href="/cloudnativenotes/assets/docker-namespace.html-CkkVUzCp.js"><link rel="modulepreload" href="/cloudnativenotes/assets/docker-namespace.html-DkDkZSP1.js">
    <link rel="prefetch" href="/cloudnativenotes/assets/index.html-CaDEAGlr.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/summary.html-5z9O3CRM.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/cron.html-BJpwXMoc.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/distributed-cache.html-BKPXsc_g.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/distributed-lock.html-Bkc2bnt8.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/session.html-DcEZyuC3.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/tracing.html-yfpjvzw7.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/uniqueid.html-DUYGPfKT.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/cap.html-B_eIltcI.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/clock.html-KdfBpAtx.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/consistency-and-consensus.html-B_fCTLL3.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/overview.html-Bgzt7s1r.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/sharding-and-replication.html-DUvyRyQl.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/transaction.html-CtA4W0xM.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/about.html-Bj3jP03N.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/dots.html-BFeEvQ5S.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/learn.html-CcJfDuaJ.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/perspective.html-Cm4yK9nC.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/responsibility.html-Dim4SFw7.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/toc.html-DvyeioSm.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/01.service-discovery.html-DCArp20B.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/02.service-config.html-wuC-D5mv.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/06.service-health.html-BYhliNkX.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/07.service-resilience-01.html-Dj-QSlZB.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/07.service-resilience-02.html-DUX16yyQ.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/08.traffic-schedule.html-Dxbe7Y59.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/index.html-Bb_GtxkL.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/index.html-fbfqkZuh.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/architecture.html-DJlJ8uIA.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/computing.html-Dcz7xqt8.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/definition.html-DcY1Fd2x.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/pass.html-CpqYH6Ci.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/index.html-ahw7-hdr.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/docker-arch.html-BgXIXtLU.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/docker-cgroups.html-oZZix2EO.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/docker-devicemapper.html-CeexLsdc.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/docker-filesystem.html-CqqKrl0p.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/docker.html-BYi6I0z-.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/index.html-DZ8leFL_.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/cicd.html-BQwJRK1k.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/devops.html-Bkik9OU5.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/gitflow.html-BGbxGwE2.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/index.html-D-_Pw43X.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/application.html-DxKvtGl3.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/architecture.html-CgZOV9r7.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/cka.html-CPTlxrnN.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/config.html-velI3VEj.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/controller.html-k2T6cqne.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/future.html-BsLZsvYN.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/monitoring.html-DTZQN_t0.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/network.html-DBksTdnb.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/pod.html-DvVxe9V4.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/scheduler.html-CAcDBcea.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/security.html-DWM-cXsC.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/storage.html-DOJKqM46.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/index.html-WEBBo--q.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/definition.html-DC1x1JT3.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/logging.html-BmDmiZXu.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/metrics.html-BIerCiie.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/monitoring.html-Dyz9s1ab.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/trace.html-CVfGSZ9N.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/dependency.html-BKhmP467.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/discovery.html-BV343_90.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/lifecycle.html-CDWsGv0r.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/scale.html-H75RsCaz.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/stack.html-r7RjtVmp.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/communication.html-BXw213ih.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/design.html-CTn3BIoS.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/servicemesh.html-DtdX3YpQ.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/rest.html-C1iE-8Cc.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/webapi.html-CHk3nZs5.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/index.html-9l9raxog.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/history.html-CVrvIJBh.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/index.html-9l9raxog.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/mysql.html-C7Za4xWb.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/nosql.html-CZOZOwW8.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/REAEMD.html-CkzaJNpe.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/auth.html-DEvRT4s_.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/permission.html-DxiAcbsM.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/roadmap.html-CSbh4B2o.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/tls-cert.html-lCTnlmUr.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/contract.html-f9rU0CZJ.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/function.html-COBB1Ko5.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/load.html-DuAW42s-.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/spring-boot-unit-testing.html-CSz971jG.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/testcontainer.html-DJN5emyo.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/unit-test.html-BuuSHng_.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/availability.html-eZd_Y02n.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/decoupling.html-BoiDHrhp.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/fault-tolerance.html-BN40USBU.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/patterns.html-n88CnXZx.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/redundancy.html-CjCijiXC.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/loadbalancing.html-CWkvv6J6.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/mirroring.html-CpQrip5y.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/rate-limiting.html-4-4WIe2F.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/routing.html-D5F4XlL8.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/404.html-DqZtwkbf.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/index.html-DsMxHoe1.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/summary.html-Q6t1kFgr.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/cron.html-Dra8Tne5.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/distributed-cache.html-ty6fkx7S.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/distributed-lock.html-IGRU4884.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/session.html-B9otZ8y_.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/tracing.html-DqqQpAG7.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/uniqueid.html-BJ4CDN8L.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/cap.html-hpEFshBw.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/clock.html-Bw-k7agB.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/consistency-and-consensus.html-CMgxqBLl.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/overview.html-BDQ2tztl.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/sharding-and-replication.html-BPvJZka6.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/transaction.html-BRXvto4R.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/about.html-bDLcxvSU.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/dots.html-2bB6Ku5l.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/learn.html-D5_C_y2e.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/perspective.html-CuEkVcup.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/responsibility.html-D2uQ6HKY.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/toc.html-CCU8umSy.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/01.service-discovery.html-CJAFPF0c.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/02.service-config.html-C0dT9MoJ.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/06.service-health.html-x4gh2uOy.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/07.service-resilience-01.html-C6878baV.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/07.service-resilience-02.html-DC3AQT_a.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/08.traffic-schedule.html-DgSx9VI2.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/index.html-Br69DyaM.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/index.html-CRtCP2eX.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/architecture.html-ndQf8NmT.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/computing.html-DAdfg3A6.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/definition.html-1slUJu0S.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/pass.html-BI14EvKo.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/index.html-ocX59_KX.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/docker-arch.html-sAcu90h4.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/docker-cgroups.html-yRJlFdgp.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/docker-devicemapper.html-DyyGUOsZ.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/docker-filesystem.html-B-AjM8BT.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/docker.html-BLzfnp1G.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/index.html-Bcpe9sBH.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/cicd.html-DnIxr7nV.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/devops.html-rSNNi7J-.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/gitflow.html-CeOrhknP.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/index.html-CtiE0YWL.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/application.html-BFOT_eF4.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/architecture.html-Dc4NXGaN.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/cka.html-CgPyOSG3.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/config.html-CqHsKfL2.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/controller.html-DjkUXQkH.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/future.html-D34sD3Y8.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/monitoring.html-CToHqHbr.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/network.html-BJLLLwuE.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/pod.html-wpRnt80g.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/scheduler.html-ChB2Dnju.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/security.html-B1mAlvG1.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/storage.html-DfrhP5dU.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/index.html-DuVr14wn.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/definition.html-CYhZ0K2_.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/logging.html-DZ1T0vlO.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/metrics.html-NpQXjRPE.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/monitoring.html-BbJFPRdf.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/trace.html-B6jHcs82.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/dependency.html-CLPqcmBN.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/discovery.html-DLnVIG59.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/lifecycle.html-DbMEvmWs.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/scale.html-CD8rqfDC.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/stack.html-y5jQssus.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/communication.html-AUvi7IaZ.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/design.html-CmHJURnv.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/servicemesh.html-SLNvveq9.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/rest.html-BuuGuwVc.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/webapi.html-BFHol3Z1.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/index.html-BLuU14Un.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/history.html-Bo5Jk6Z9.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/index.html-BLuU14Un.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/mysql.html-DY6VZY0J.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/nosql.html-BnPzgDlf.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/REAEMD.html-B9hyN1MS.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/auth.html-C1IynFQA.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/permission.html-6DRnqYOD.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/roadmap.html-Cj29XfbQ.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/tls-cert.html-DQRQ2S_V.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/contract.html-DLjt-c0Q.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/function.html-COQyIpZW.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/load.html-4Xd7pdLN.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/spring-boot-unit-testing.html-DNhjdjQR.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/testcontainer.html-CdxrgXLE.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/unit-test.html-BnApfdzU.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/availability.html-B6i0aGsC.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/decoupling.html-T03ienA-.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/fault-tolerance.html-CoDoYsNs.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/patterns.html-XA-MeAJP.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/redundancy.html-Cw-rGKyJ.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/loadbalancing.html-CMPnvy1k.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/mirroring.html-B4Yk6fXQ.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/rate-limiting.html-XirS-n2q.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/routing.html-BqsuJym0.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/404.html-BpKyP9F4.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/giscus-DrGxERkK.js" as="script"><link rel="prefetch" href="/cloudnativenotes/assets/buttons.esm-DK2fWHEW.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container" data-v-efed79f6><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/cloudnativenotes/" class=""><img class="logo" src="/cloudnativenotes/images/microservices-logo.svg" alt="云原生架构笔记"><span class="site-name can-hide">云原生架构笔记</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/cloudnativenotes/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/zouyingjie/cloudnativenotes/discussions" rel="noopener noreferrer" target="_blank" aria-label="讨论"><!--[--><!--]--> 讨论 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/zouyingjie/cloudnativenotes" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/cloudnativenotes/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/zouyingjie/cloudnativenotes/discussions" rel="noopener noreferrer" target="_blank" aria-label="讨论"><!--[--><!--]--> 讨论 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/zouyingjie/cloudnativenotes" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><a href="/cloudnativenotes/end/about.md" class="sidebar-item sidebar-heading" aria-label="前言"><!--[--><!--]--> 前言 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/end/toc.md" class="sidebar-item sidebar-heading" aria-label="目录"><!--[--><!--]--> 目录 <!--[--><!--]--></a><!----></li><li><p tabindex="0" class="sidebar-item sidebar-heading">通用设计 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><p tabindex="0" class="sidebar-item">数据建模 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/cloudnativenotes/common-design/modeling/history.html" class="sidebar-item" aria-label="DBMS的演进"><!--[--><!--]--> DBMS的演进 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/common-design/modeling/" class="sidebar-item" aria-label="数据库索引设计与优化"><!--[--><!--]--> 数据库索引设计与优化 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/common-design/modeling/mysql.html" class="sidebar-item" aria-label="MySQL 开发规范"><!--[--><!--]--> MySQL 开发规范 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/common-design/modeling/nosql.html" class="sidebar-item" aria-label="NoSQL 建模规范"><!--[--><!--]--> NoSQL 建模规范 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item">API 设计 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/cloudnativenotes/common-design/api/rest.html" class="sidebar-item" aria-label="WEB API 设计规范"><!--[--><!--]--> WEB API 设计规范 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/common-design/api/webapi.html" class="sidebar-item" aria-label="Web API 路径设计哪家强"><!--[--><!--]--> Web API 路径设计哪家强 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item">认证与授权 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/cloudnativenotes/common-design/security/roadmap.html" class="sidebar-item" aria-label="方案概览"><!--[--><!--]--> 方案概览 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/common-design/security/auth.html" class="sidebar-item" aria-label="身份认证"><!--[--><!--]--> 身份认证 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/common-design/security/permission.html" class="sidebar-item" aria-label="授权管理"><!--[--><!--]--> 授权管理 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading">分布式系统-理论篇 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/cloudnativenotes/distributed-system-theory/overview.html" class="sidebar-item" aria-label="分布式系统概览"><!--[--><!--]--> 分布式系统概览 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/distributed-system-theory/sharding-and-replication.html" class="sidebar-item" aria-label="数据分区与复制"><!--[--><!--]--> 数据分区与复制 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/distributed-system-theory/consistency-and-consensus.html" class="sidebar-item" aria-label="分布式共识"><!--[--><!--]--> 分布式共识 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/distributed-system-theory/transaction.html" class="sidebar-item" aria-label="分布式事务"><!--[--><!--]--> 分布式事务 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/distributed-system-theory/clock.html" class="sidebar-item" aria-label="分布式时钟"><!--[--><!--]--> 分布式时钟 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading">分布式系统-工程篇 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/cloudnativenotes/distributed-system-engineering/distributed-lock.html" class="sidebar-item" aria-label="分布式锁的设计"><!--[--><!--]--> 分布式锁的设计 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/distributed-system-engineering/uniqueid.html" class="sidebar-item" aria-label="分布式唯一 ID"><!--[--><!--]--> 分布式唯一 ID <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/distributed-system-engineering/cron.html" class="sidebar-item" aria-label="分布式任务调度"><!--[--><!--]--> 分布式任务调度 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/distributed-system-engineering/session.html" class="sidebar-item" aria-label="分布式会话"><!--[--><!--]--> 分布式会话 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/distributed-system-engineering/tracing.html" class="sidebar-item" aria-label="分布式追踪"><!--[--><!--]--> 分布式追踪 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a href="/cloudnativenotes/cloudnative/summary.md" class="sidebar-item sidebar-heading active" aria-label="云原生架构"><!--[--><!--]--> 云原生架构 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><p tabindex="0" class="sidebar-item">什么是云原生 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/cloudnativenotes/cloudnative/architecture/architecture.html" class="sidebar-item" aria-label="分布式系统的演进"><!--[--><!--]--> 分布式系统的演进 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/cloudnative/architecture/definition.html" class="sidebar-item" aria-label="云原生的定义"><!--[--><!--]--> 云原生的定义 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/cloudnative/architecture/pass.html" class="sidebar-item" aria-label="云原生平台的构建"><!--[--><!--]--> 云原生平台的构建 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item active">不可变基础设施 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><p tabindex="0" class="sidebar-item active">容器 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/cloudnativenotes/cloudnative/container/docker-namespace.html" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="容器基础技术：namespace"><!--[--><!--]--> 容器基础技术：namespace <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/cloudnativenotes/cloudnative/container/docker-namespace.html#namespace-类型" class="router-link-active router-link-exact-active sidebar-item" aria-label="namespace 类型"><!--[--><!--]--> namespace 类型 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/cloudnativenotes/cloudnative/container/docker-namespace.html#系统调用" class="router-link-active router-link-exact-active sidebar-item" aria-label="系统调用"><!--[--><!--]--> 系统调用 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/cloudnativenotes/cloudnative/container/docker-namespace.html#setns-unshare-系统调用" class="router-link-active router-link-exact-active sidebar-item" aria-label="setns &amp; unshare 系统调用"><!--[--><!--]--> setns &amp; unshare 系统调用 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/cloudnativenotes/cloudnative/container/docker-namespace.html#clone-系统调用" class="router-link-active router-link-exact-active sidebar-item" aria-label="clone 系统调用"><!--[--><!--]--> clone 系统调用 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/cloudnativenotes/cloudnative/container/docker-namespace.html#namespace-详解" class="router-link-active router-link-exact-active sidebar-item" aria-label="namespace 详解"><!--[--><!--]--> namespace 详解 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/cloudnativenotes/cloudnative/container/docker-namespace.html#uts-namespace" class="router-link-active router-link-exact-active sidebar-item" aria-label="UTS namespace"><!--[--><!--]--> UTS namespace <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/cloudnativenotes/cloudnative/container/docker-namespace.html#pid-namespace" class="router-link-active router-link-exact-active sidebar-item" aria-label="PID namespace"><!--[--><!--]--> PID namespace <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/cloudnativenotes/cloudnative/container/docker-namespace.html#ipc-namespace" class="router-link-active router-link-exact-active sidebar-item" aria-label="IPC namespace"><!--[--><!--]--> IPC namespace <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/cloudnativenotes/cloudnative/container/docker-namespace.html#mount-namespace" class="router-link-active router-link-exact-active sidebar-item" aria-label="Mount namespace"><!--[--><!--]--> Mount namespace <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/cloudnativenotes/cloudnative/container/docker-namespace.html#user-namespace" class="router-link-active router-link-exact-active sidebar-item" aria-label="User namespace"><!--[--><!--]--> User namespace <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/cloudnativenotes/cloudnative/container/docker-namespace.html#network-namespace" class="router-link-active router-link-exact-active sidebar-item" aria-label="Network namespace"><!--[--><!--]--> Network namespace <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/cloudnativenotes/cloudnative/container/docker-namespace.html#cgroup-namespace" class="router-link-active router-link-exact-active sidebar-item" aria-label="Cgroup namespace"><!--[--><!--]--> Cgroup namespace <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/cloudnativenotes/cloudnative/container/docker-namespace.html#time-namespace" class="router-link-active router-link-exact-active sidebar-item" aria-label="Time namespace"><!--[--><!--]--> Time namespace <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a href="/cloudnativenotes/cloudnative/container/docker-cgroups.html" class="sidebar-item" aria-label="容器基础技术：cgroups"><!--[--><!--]--> 容器基础技术：cgroups <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/cloudnative/container/docker-filesystem.html" class="sidebar-item" aria-label="容器基础技术：文件系统"><!--[--><!--]--> 容器基础技术：文件系统 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/cloudnative/container/docker-devicemapper.html" class="sidebar-item" aria-label="容器基础技术：devicemapper"><!--[--><!--]--> 容器基础技术：devicemapper <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/cloudnative/container/docker.html" class="sidebar-item" aria-label="Docker 最佳实践"><!--[--><!--]--> Docker 最佳实践 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item">Kubernetes <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/cloudnativenotes/cloudnative/kubernetes/architecture.html" class="sidebar-item" aria-label="整体架构"><!--[--><!--]--> 整体架构 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/cloudnative/kubernetes/pod.html" class="sidebar-item" aria-label="Pod 那些事"><!--[--><!--]--> Pod 那些事 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/cloudnative/kubernetes/controller.html" class="sidebar-item" aria-label="控制器对象"><!--[--><!--]--> 控制器对象 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/cloudnative/kubernetes/config.html" class="sidebar-item" aria-label="配置管理对象"><!--[--><!--]--> 配置管理对象 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/cloudnative/kubernetes/network.html" class="sidebar-item" aria-label="网络原理"><!--[--><!--]--> 网络原理 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/cloudnative/kubernetes/storage.html" class="sidebar-item" aria-label="存储原理"><!--[--><!--]--> 存储原理 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/cloudnative/kubernetes/scheduler.html" class="sidebar-item" aria-label="调度原理"><!--[--><!--]--> 调度原理 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/cloudnative/kubernetes/security.html" class="sidebar-item" aria-label="安全机制"><!--[--><!--]--> 安全机制 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/cloudnative/kubernetes/application.html" class="sidebar-item" aria-label="应用封装与扩展"><!--[--><!--]--> 应用封装与扩展 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/cloudnative/kubernetes/monitoring.html" class="sidebar-item" aria-label="集群监控与 debug"><!--[--><!--]--> 集群监控与 debug <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item">服务网格 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/cloudnativenotes/cloudnative/servicemesh/communication.html" class="sidebar-item" aria-label="服务通信的演进"><!--[--><!--]--> 服务通信的演进 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/cloudnative/servicemesh/servicemesh.html" class="sidebar-item" aria-label="服务网格产品与生态"><!--[--><!--]--> 服务网格产品与生态 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/cloudnative/servicemesh/design.html" class="sidebar-item" aria-label="服务网格的设计"><!--[--><!--]--> 服务网格的设计 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item">服务治理 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/cloudnativenotes/cloudnative/service/dependency.html" class="sidebar-item" aria-label="服务依赖管理"><!--[--><!--]--> 服务依赖管理 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/cloudnative/service/stack.html" class="sidebar-item" aria-label="服务整栈编排"><!--[--><!--]--> 服务整栈编排 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/cloudnative/service/discovery.html" class="sidebar-item" aria-label="服务注册与发现"><!--[--><!--]--> 服务注册与发现 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/cloudnative/service/lifecycle.html" class="sidebar-item" aria-label="服务生命周期管理"><!--[--><!--]--> 服务生命周期管理 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item">流量治理 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/cloudnativenotes/cloudnative/service/traffic/loadbalancing.html" class="sidebar-item" aria-label="负载均衡"><!--[--><!--]--> 负载均衡 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/cloudnative/service/traffic/routing.html" class="sidebar-item" aria-label="流量路由"><!--[--><!--]--> 流量路由 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/cloudnative/service/traffic/rate-limiting.html" class="sidebar-item" aria-label="限流设计"><!--[--><!--]--> 限流设计 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/cloudnative/service/traffic/mirroring.html" class="sidebar-item" aria-label="流量镜像"><!--[--><!--]--> 流量镜像 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item">可观测性 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/cloudnativenotes/cloudnative/observability/definition.html" class="sidebar-item" aria-label="什么是可观测性"><!--[--><!--]--> 什么是可观测性 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/cloudnative/observability/metrics.html" class="sidebar-item" aria-label="指标"><!--[--><!--]--> 指标 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/cloudnative/observability/logging.html" class="sidebar-item" aria-label="日志"><!--[--><!--]--> 日志 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/cloudnative/observability/trace.html" class="sidebar-item" aria-label="链路追踪"><!--[--><!--]--> 链路追踪 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/cloudnative/observability/monitoring.html" class="sidebar-item" aria-label="全栈监控系统架构"><!--[--><!--]--> 全栈监控系统架构 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item">DevOps <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/cloudnativenotes/cloudnative/devops/devops.html" class="sidebar-item" aria-label="打造企业 DevOps 文化"><!--[--><!--]--> 打造企业 DevOps 文化 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/cloudnative/devops/gitflow.html" class="sidebar-item" aria-label="软件开发工作流"><!--[--><!--]--> 软件开发工作流 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/cloudnative/devops/cicd.html" class="sidebar-item" aria-label="CI/CD 最佳实践"><!--[--><!--]--> CI/CD 最佳实践 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading">何以为架构师 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/cloudnativenotes/end/responsibility.html" class="sidebar-item" aria-label="架构师的职责"><!--[--><!--]--> 架构师的职责 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/end/perspective.html" class="sidebar-item" aria-label="架构师的视角"><!--[--><!--]--> 架构师的视角 <!--[--><!--]--></a><!----></li><li><a href="/cloudnativenotes/end/learn.html" class="sidebar-item" aria-label="架构师的学习"><!--[--><!--]--> 架构师的学习 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a href="/cloudnativenotes/end/dots.md" class="sidebar-item sidebar-heading" aria-label="后记：那些平淡的一天"><!--[--><!--]--> 后记：那些平淡的一天 <!--[--><!--]--></a><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="容器基础技术-namespace" tabindex="-1"><a class="header-anchor" href="#容器基础技术-namespace" aria-hidden="true">#</a> 容器基础技术：namespace</h1><p>在容器内进程是隔离的，容器有自己的网络和文件系统，容器内进程的 PID 为 1，这些都是依赖于 Linux namespace 所提供的隔离机制。本篇我们来了解下 Linux 有哪些 namespace，以及它们是如何实现隔离的。</p><blockquote><p>文中案例代码均由 ChatGPT 生成，在 Linux 内核 5.15.0-124-generic，ubuntu 22.04 LTS 系统上测试通过。</p></blockquote><h2 id="namespace-类型" tabindex="-1"><a class="header-anchor" href="#namespace-类型" aria-hidden="true">#</a> namespace 类型</h2><p><img src="https://abdelouahabmbarki.com/content/images/2022/12/Screenshot-from-2022-12-28-19-58-37.png" alt="namespace"></p><p>每个进程都有自己所属的 namespace，可以在 <code>/proc/&lt;pid&gt;/ns/</code> 目录下查看。自 Linux 3.8 版本开始，该目录下的文件以软连接的形式存在，如果两个进程同属于一个 namespace，那么它们对应的文件是相同的，软连接指向同一个文件。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>$ sudo ls -al /proc/1506573/ns
total 0
dr-x--x--x 2 root root 0 Mar  2 10:53 .
dr-xr-xr-x 9 root root 0 Mar  2 09:24 ..
lrwxrwxrwx 1 root root 0 Mar  2 10:53 cgroup -&gt; &#39;cgroup:[4026531835]&#39;
lrwxrwxrwx 1 root root 0 Mar  2 10:53 ipc -&gt; &#39;ipc:[4026531839]&#39;
lrwxrwxrwx 1 root root 0 Mar  2 10:53 mnt -&gt; &#39;mnt:[4026531841]&#39;
lrwxrwxrwx 1 root root 0 Mar  2 10:53 net -&gt; &#39;net:[4026531840]&#39;
lrwxrwxrwx 1 root root 0 Mar  2 10:53 pid -&gt; &#39;pid:[4026531836]&#39;
lrwxrwxrwx 1 root root 0 Mar  2 10:53 pid_for_children -&gt; &#39;pid:[4026531836]&#39;
lrwxrwxrwx 1 root root 0 Mar  2 10:53 time -&gt; &#39;time:[4026531834]&#39;
lrwxrwxrwx 1 root root 0 Mar  2 10:53 time_for_children -&gt; &#39;time:[4026531834]&#39;
lrwxrwxrwx 1 root root 0 Mar  2 10:53 user -&gt; &#39;user:[4026531837]&#39;
lrwxrwxrwx 1 root root 0 Mar  2 10:53 uts -&gt; &#39;uts:[4026531838]&#39;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>目前 Linux 内核有 8 种 namespace，其类型和功能如下：</p><table><thead><tr><th>类型</th><th>系统调用参数</th><th>功能</th><th>内核版本</th></tr></thead><tbody><tr><td>Mount namespace</td><td>CLONE_NEWNS</td><td>隔离文件系统挂载点</td><td>Linux2.4.19，是第一个被引入的 namespace</td></tr><tr><td>UTS namespace</td><td>CLONE_NEWUTS</td><td>隔离主机名和域名</td><td>Linux2.6.19</td></tr><tr><td>IPC namespace</td><td>CLONE_NEWIPC</td><td>隔离进程间通信</td><td>Linux2.6.19</td></tr><tr><td>PID namespace</td><td>CLONE_NEWPID</td><td>隔离进程 ID</td><td>Linux2.6.24</td></tr><tr><td>Network namespace</td><td>CLONE_NEWNET</td><td>隔离网络</td><td>Linux2.6.29</td></tr><tr><td>User namespace</td><td>CLONE_NEWUSER</td><td>隔离用户和组</td><td>Linux3.8</td></tr><tr><td>Cgroup namespace</td><td>CLONE_NEWCGROUP</td><td>隔离控制组</td><td>Linux4.6</td></tr><tr><td>Time namespace</td><td>CLONE_NEWTIME</td><td>隔离系统时间</td><td>Linux5.6</td></tr></tbody></table><h2 id="系统调用" tabindex="-1"><a class="header-anchor" href="#系统调用" aria-hidden="true">#</a> 系统调用</h2><p>上面我们列出了每种 namespace 的系统调用参数，要对进程实现某个 namespace 的隔离，只需要修改已有进程或者在创建进程时指定对应的参数即可。这里主要涉及三个系统调用：</p><ul><li><code>setns</code>：将某个进程加入到某个已有 namespace。</li><li><code>unshare</code>：将某个进程从某个类型的 namespace 移除，并加入到新的 namespace。</li><li><code>clone</code>：创建新进程，可以通过传递上述参数达到隔离效果。</li></ul><p>我们来分别看下这三个系统调用的使用。</p><h3 id="setns-unshare-系统调用" tabindex="-1"><a class="header-anchor" href="#setns-unshare-系统调用" aria-hidden="true">#</a> setns &amp; unshare 系统调用</h3><p>这两个系统调用比较简单，我们用一段代码来演示下。</p><p>首先我们利用 unshare 系统调用先创建一个新的 UTS namespace（隔离主机名）并设置新的主机名，然后通过 <code>setns</code> 将某个进程加入到该 namespace 中，在通过 <code>unshare</code> 将该进程从该 namespace 中移除。</p><ul><li>unshare 代码</li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_GNU_SOURCE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sched.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建新的 UTS Namespace</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unshare</span><span class="token punctuation">(</span>CLONE_NEWUTS<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;unshare&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 修改当前 namespace 内的 hostname</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sethostname</span><span class="token punctuation">(</span><span class="token string">&quot;new-namespace&quot;</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;sethostname&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Namespace created, new hostname set to: new-namespace\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 进入 shell，让用户可以交互</span>
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">&quot;/bin/bash&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>编译并运行，可以看到新的进程其 hostname 已经变成了 <code>new-namespace</code>。如果我们新开一个终端，宿主机上执行 <code>hostname</code> 命令，可以看到主机名仍然是 <code>node1</code>。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># ubuntu @ node1 in ~/tmp [16:13:06]</span>
$ gcc unshare.c <span class="token parameter variable">-o</span> unshare_ns



<span class="token comment"># ubuntu @ node1 in ~/tmp [16:13:09]</span>
$ <span class="token function">sudo</span> ./unshare_ns
Namespace created, new <span class="token function">hostname</span> <span class="token builtin class-name">set</span> to: new-namespace
root@new-namespace:/home/ubuntu/tmp<span class="token comment"># hostname</span>
new-namespace
root@new-namespace:/home/ubuntu/tmp<span class="token comment">#</span>
<span class="token builtin class-name">exit</span>

<span class="token comment"># ubuntu @ node1 in ~/tmp [16:14:26]</span>
$ <span class="token function">hostname</span>
node1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接下来我们利用 setns 系统调用将当前进程加入我们刚刚创建的 UTS namespace 中。我们先看下之前的进程 pid：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">sudo</span> ./unshare_ns
Namespace created, new <span class="token function">hostname</span> <span class="token builtin class-name">set</span> to: new-namespace
root@new-namespace:/home/ubuntu/tmp<span class="token comment"># hostname</span>
new-namespace
root@new-namespace:/home/ubuntu/tmp<span class="token comment"># echo $$</span>
<span class="token number">1341239</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Linux 的 namespace 路径在 <code>/proc/&lt;pid&gt;/ns/</code> 目录下，我们可以通过 <code>ls -l /proc/&lt;pid&gt;/ns/</code> 命令查看。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">sudo</span> <span class="token function">ls</span> <span class="token parameter variable">-l</span> /proc/1341239/ns
total <span class="token number">0</span>
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">0</span> Feb  <span class="token number">5</span> <span class="token number">16</span>:18 cgroup -<span class="token operator">&gt;</span> <span class="token string">&#39;cgroup:[4026531835]&#39;</span>
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">0</span> Feb  <span class="token number">5</span> <span class="token number">16</span>:18 ipc -<span class="token operator">&gt;</span> <span class="token string">&#39;ipc:[4026531839]&#39;</span>
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">0</span> Feb  <span class="token number">5</span> <span class="token number">16</span>:18 mnt -<span class="token operator">&gt;</span> <span class="token string">&#39;mnt:[4026531841]&#39;</span>
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">0</span> Feb  <span class="token number">5</span> <span class="token number">16</span>:18 net -<span class="token operator">&gt;</span> <span class="token string">&#39;net:[4026531840]&#39;</span>
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">0</span> Feb  <span class="token number">5</span> <span class="token number">16</span>:18 pid -<span class="token operator">&gt;</span> <span class="token string">&#39;pid:[4026531836]&#39;</span>
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">0</span> Feb  <span class="token number">5</span> <span class="token number">16</span>:18 pid_for_children -<span class="token operator">&gt;</span> <span class="token string">&#39;pid:[4026531836]&#39;</span>
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">0</span> Feb  <span class="token number">5</span> <span class="token number">16</span>:18 <span class="token function">time</span> -<span class="token operator">&gt;</span> <span class="token string">&#39;time:[4026531834]&#39;</span>
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">0</span> Feb  <span class="token number">5</span> <span class="token number">16</span>:18 time_for_children -<span class="token operator">&gt;</span> <span class="token string">&#39;time:[4026531834]&#39;</span>
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">0</span> Feb  <span class="token number">5</span> <span class="token number">16</span>:18 user -<span class="token operator">&gt;</span> <span class="token string">&#39;user:[4026531837]&#39;</span>
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">0</span> Feb  <span class="token number">5</span> <span class="token number">16</span>:18 uts -<span class="token operator">&gt;</span> <span class="token string">&#39;uts:[4026532299]&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到有 8 种 namespace 相关的软连接，接下来我们将 UTS namespace 的文件路径作为参数给 setns 系统调用，将当前进程加入到该 namespace 中。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_GNU_SOURCE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sched.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 打开目标进程的 UTS namespace</span>
    <span class="token keyword">int</span> file_dir <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>file_dir <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;open&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 切换到目标进程的 namespace</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setns</span><span class="token punctuation">(</span>file_dir<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;setns&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>file_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">close</span><span class="token punctuation">(</span>file_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Joined namespace of process %s\n&quot;</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 启动一个新的 shell，测试是否进入了目标 Namespace</span>
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">&quot;/bin/bash&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行程序如下，可以看到当前进程的 pid 是 1346117，并且 hostname 也变成了 <code>new-namespace</code>。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ gcc setns.c <span class="token parameter variable">-o</span> set_ns

<span class="token comment"># ubuntu @ node1 in ~/tmp [16:21:18]</span>
$ <span class="token function">sudo</span> ./set_ns /proc/1341239/ns/uts <span class="token comment"># 将当前进程加入到 UTS namespace 中</span>
Joined namespace of process /proc/1341239/ns/uts
root@new-namespace:/home/ubuntu/tmp<span class="token comment"># $$</span>
<span class="token number">1346117</span>
root@new-namespace:/home/ubuntu/tmp<span class="token comment"># hostname</span>
new-namespace
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="clone-系统调用" tabindex="-1"><a class="header-anchor" href="#clone-系统调用" aria-hidden="true">#</a> clone 系统调用</h3><p>unshare 和 setns 都是对当前进程进行操作，用法也比较简单，实际工作中我们更多的是启动容器，创建新的进程。</p><p>clone() 是 Linux 提供的创建新进程的底层系统调用，类似 fork()，但它更灵活，可以通过传递众多的 FLAG 参数来控制新进程是否共享特定的资源（如 PID、文件描述符、内存、命名空间等）。</p><p>除了上面提到的 namespace 相关的 FLAG，clone() 还支持很多其他的 FLAG，比如：</p><table><thead><tr><th>Flag</th><th>功能</th></tr></thead><tbody><tr><td>CLONE_VM</td><td>共享内存地址空间（创建线程时使用）</td></tr><tr><td>CLONE_FS</td><td>共享文件系统信息</td></tr><tr><td>CLONE_FILES</td><td>共享文件描述符</td></tr><tr><td>CLONE_SIGHAND</td><td>共享信号处理</td></tr><tr><td>CLONE_THREAD</td><td>创建线程组</td></tr></tbody></table><p>我们使用如下代码作为示例，后续介绍各个 namespace 时，会在该代码基础上进行修改。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_GNU_SOURCE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sched.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span>

<span class="token comment">// 分配子进程的栈空间（clone 需要手动提供栈）</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">STACK_SIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span>  </span><span class="token comment">// 1MB</span></span>
<span class="token keyword">static</span> <span class="token keyword">char</span> child_stack<span class="token punctuation">[</span>STACK_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 子进程执行的函数</span>
<span class="token keyword">int</span> <span class="token function">child_function</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Entering child shell (PID: %d)\n&quot;</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 运行 /bin/bash 交互式 shell</span>
    <span class="token function">execlp</span><span class="token punctuation">(</span><span class="token string">&quot;/bin/bash&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/bin/bash&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-i&quot;</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// execlp() 失败时返回错误</span>
    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;execlp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Parent process PID: %d\n&quot;</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建子进程，并运行 bash</span>
    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">clone</span><span class="token punctuation">(</span>child_function<span class="token punctuation">,</span> child_stack <span class="token operator">+</span> STACK_SIZE<span class="token punctuation">,</span> SIGCHLD<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;clone&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 等待子进程结束</span>
    <span class="token function">waitpid</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Child process exited\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="namespace-详解" tabindex="-1"><a class="header-anchor" href="#namespace-详解" aria-hidden="true">#</a> namespace 详解</h2><p>接下来我们基于上述代码做修改，来详细看下各个 namespace 的用途和实现方式。</p><h3 id="uts-namespace" tabindex="-1"><a class="header-anchor" href="#uts-namespace" aria-hidden="true">#</a> UTS namespace</h3><p>首先我们继续看下 UTS namespace，UTS 是 Unix Timesharing System 的缩写，UTS namespace 主要隔离了主机名和域名。我们修改上面 clone 系统调用的代码，在创建子进程时，指定 <strong>CLONE_NEWUTS</strong> 参数。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>
<span class="token keyword">int</span> <span class="token function">child_function</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Entering child shell (PID: %d)\n&quot;</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 设置主机名为 children</span>
    <span class="token function">sethostname</span><span class="token punctuation">(</span><span class="token string">&quot;children&quot;</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">execlp</span><span class="token punctuation">(</span><span class="token string">&quot;/bin/bash&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/bin/bash&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-i&quot;</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;execlp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Parent process PID: %d\n&quot;</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建子进程，设置 CLONE_NEWUTS 参数</span>
    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">clone</span><span class="token punctuation">(</span>child_function<span class="token punctuation">,</span> child_stack <span class="token operator">+</span> STACK_SIZE<span class="token punctuation">,</span> CLONE_NEWUTS <span class="token operator">|</span> SIGCHLD<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;clone&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 等待子进程结束</span>
    <span class="token function">waitpid</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Child process exited\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这时候我们运行程序，在子进程进入 shell 后执行命令可以看到主机名已经变成了 <code>children</code>。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">sudo</span> ./clone_uts
Parent process PID: <span class="token number">2415770</span>
Entering child shell <span class="token punctuation">(</span>PID: <span class="token number">2415771</span><span class="token punctuation">)</span>
root@children:/home/ubuntu/tmp<span class="token comment"># hostname</span>
children
root@children:/home/ubuntu/tmp<span class="token comment"># uname -a</span>
Linux children <span class="token number">5.15</span>.0-124-generic <span class="token comment">#134-Ubuntu SMP Fri Sep 27 20:20:17 UTC 2024 x86_64 x86_64 x86_64 GNU/Linux</span>

root@children:/home/ubuntu/tmp<span class="token comment"># ps aux</span>
<span class="token environment constant">USER</span>         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root           <span class="token number">1</span>  <span class="token number">0.0</span>  <span class="token number">0.3</span> <span class="token number">168244</span> <span class="token number">11676</span> ?        Ss    <span class="token number">2024</span>  <span class="token number">28</span>:19 /sbin/init
root           <span class="token number">2</span>  <span class="token number">0.0</span>  <span class="token number">0.0</span>      <span class="token number">0</span>     <span class="token number">0</span> ?        S     <span class="token number">2024</span>   <span class="token number">0</span>:00 <span class="token punctuation">[</span>kthreadd<span class="token punctuation">]</span>
root           <span class="token number">3</span>  <span class="token number">0.0</span>  <span class="token number">0.0</span>      <span class="token number">0</span>     <span class="token number">0</span> ?        I<span class="token operator">&lt;</span>    <span class="token number">2024</span>   <span class="token number">0</span>:00 <span class="token punctuation">[</span>rcu_gp<span class="token punctuation">]</span>
root           <span class="token number">4</span>  <span class="token number">0.0</span>  <span class="token number">0.0</span>      <span class="token number">0</span>     <span class="token number">0</span> ?        I<span class="token operator">&lt;</span>    <span class="token number">2024</span>   <span class="token number">0</span>:00 <span class="token punctuation">[</span>rcu_par_gp<span class="token punctuation">]</span>
root           <span class="token number">5</span>  <span class="token number">0.0</span>  <span class="token number">0.0</span>      <span class="token number">0</span>     <span class="token number">0</span> ?        I<span class="token operator">&lt;</span>    <span class="token number">2024</span>   <span class="token number">0</span>:00 <span class="token punctuation">[</span>slub_flushwq<span class="token punctuation">]</span>
root           <span class="token number">6</span>  <span class="token number">0.0</span>  <span class="token number">0.0</span>      <span class="token number">0</span>     <span class="token number">0</span> ?        I<span class="token operator">&lt;</span>    <span class="token number">2024</span>   <span class="token number">0</span>:00 <span class="token punctuation">[</span>netns<span class="token punctuation">]</span>
<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="pid-namespace" tabindex="-1"><a class="header-anchor" href="#pid-namespace" aria-hidden="true">#</a> PID namespace</h3><p>PID namespace 主要隔离了进程 ID，每个 namespace 内的进程 ID 都是从 1 开始，并且相互隔离。运行上面的代码时，可以看到子进程的 PID 是 2415771。我们修改代码，在创建子进程时，指定 <strong>CLONE_NEWPID</strong> 参数。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">child_function</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Entering child shell (PID: %d)\n&quot;</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 设置主机名为 children</span>
    <span class="token function">sethostname</span><span class="token punctuation">(</span><span class="token string">&quot;children&quot;</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">execlp</span><span class="token punctuation">(</span><span class="token string">&quot;/bin/bash&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/bin/bash&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-i&quot;</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;execlp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Parent process PID: %d\n&quot;</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建子进程，设置 CLONE_NEWUTS 参数</span>
    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">clone</span><span class="token punctuation">(</span>child_function<span class="token punctuation">,</span> child_stack <span class="token operator">+</span> STACK_SIZE<span class="token punctuation">,</span> CLONE_NEWUTS <span class="token operator">|</span> CLONE_NEWPID <span class="token operator">|</span> SIGCHLD<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;clone&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 等待子进程结束</span>
    <span class="token function">waitpid</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Child process exited\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>再次运行程序，可以看到子进程的 PID 会变成 1。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>$ sudo <span class="token punctuation">.</span><span class="token operator">/</span>clone_pid
Parent process PID<span class="token operator">:</span> <span class="token number">2420560</span>
Entering new <span class="token function">shell</span> <span class="token punctuation">(</span>PID<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当然，如果我们查看主机上的进程，可以看到子进程的 PID 是 2420561。这和我们使用 Docker 时，在容器中看到的进程 ID 为 1，在主机上看到的进程 ID 为其他值，其原理是一样的。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>root     <span class="token number">2420560</span>  <span class="token number">0.0</span>  <span class="token number">0.0</span>   <span class="token number">3800</span>   <span class="token number">976</span> pts<span class="token operator">/</span><span class="token number">1</span>    S    <span class="token number">15</span><span class="token operator">:</span><span class="token number">06</span>   <span class="token number">0</span><span class="token operator">:</span><span class="token number">00</span> <span class="token punctuation">.</span><span class="token operator">/</span>clone
root     <span class="token number">2420561</span>  <span class="token number">0.0</span>  <span class="token number">0.1</span>   <span class="token number">7636</span>  <span class="token number">4288</span> pts<span class="token operator">/</span><span class="token number">1</span>    S<span class="token operator">+</span>   <span class="token number">15</span><span class="token operator">:</span><span class="token number">06</span>   <span class="token number">0</span><span class="token operator">:</span><span class="token number">00</span> <span class="token operator">/</span>bin<span class="token operator">/</span>bash <span class="token operator">-</span>i
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ipc-namespace" tabindex="-1"><a class="header-anchor" href="#ipc-namespace" aria-hidden="true">#</a> IPC namespace</h3><p>IPC（Inter-Process Communication）指的是进程间通信，Linux 支持管道、信号、共享内存、信号量、消息队列、套接字等进程间通信方式。像共享内存、消息队列、信号量这些 IPC 资源是全局共享的，为了避免多个进程之间相互干扰，需要使用 IPC namespace 进行隔离。</p><p>我们继续修改代码，在创建子进程时，指定 <strong>CLONE_NEWIPC</strong> 参数。为了校验我们代码要变得复杂一些，我们在父进程创建共享内存和消息队列，然后在子进程中尝试访问这些资源。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_GNU_SOURCE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sched.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/msg.h&gt;</span></span>

<span class="token comment">// 分配子进程的栈空间（clone 需要手动提供栈）</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">STACK_SIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span>  </span><span class="token comment">// 1MB</span></span>
<span class="token keyword">static</span> <span class="token keyword">char</span> child_stack<span class="token punctuation">[</span>STACK_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 子进程执行的函数</span>
<span class="token keyword">int</span> <span class="token function">child_function</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Entering child shell (PID: %d)\n&quot;</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">sethostname</span><span class="token punctuation">(</span><span class="token string">&quot;children&quot;</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 在子进程中执行 `ipcs -m`，查看共享内存</span>
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">&quot;ipcs -m&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 在子进程中执行 `ipcs -q`，查看消息队列</span>
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">&quot;ipcs -s&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 运行 /bin/bash 交互式 shell</span>
    <span class="token function">execlp</span><span class="token punctuation">(</span><span class="token string">&quot;/bin/bash&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/bin/bash&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-i&quot;</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// execlp() 失败时返回错误</span>
    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;execlp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Parent process PID: %d\n&quot;</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token comment">// 父进程创建一个共享内存</span>
    <span class="token keyword">int</span> shmid <span class="token operator">=</span> <span class="token function">shmget</span><span class="token punctuation">(</span>IPC_PRIVATE<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> IPC_CREAT <span class="token operator">|</span> <span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shmid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;shmget&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;[Parent] Created shared memory ID: %d\n&quot;</span><span class="token punctuation">,</span> shmid<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 父进程创建一个消息队列</span>
    <span class="token keyword">int</span> msgid <span class="token operator">=</span> <span class="token function">msgget</span><span class="token punctuation">(</span><span class="token number">1234</span><span class="token punctuation">,</span> IPC_CREAT <span class="token operator">|</span> <span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msgid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;msgget&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;[Parent] Created message queue ID: %d\n&quot;</span><span class="token punctuation">,</span> msgid<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建子进程，设置 CLONE_NEWIPC 并运行 bash</span>
    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">clone</span><span class="token punctuation">(</span>child_function<span class="token punctuation">,</span> child_stack <span class="token operator">+</span> STACK_SIZE<span class="token punctuation">,</span> CLONE_NEWUTS <span class="token operator">|</span> CLONE_NEWIPC <span class="token operator">|</span> SIGCHLD<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;clone&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 等待子进程结束</span>
    <span class="token function">waitpid</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Child process exited\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们执行代码会得到如下输出，子进程没有看到共享内存和消息队列。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">sudo</span> ./clone_ipc
Parent process PID: <span class="token number">2443935</span>
<span class="token punctuation">[</span>Parent<span class="token punctuation">]</span> Created shared memory ID: <span class="token number">2</span>
<span class="token punctuation">[</span>Parent<span class="token punctuation">]</span> Created message queue ID: <span class="token number">0</span>
Entering new shell <span class="token punctuation">(</span>PID: <span class="token number">2443936</span><span class="token punctuation">)</span>

------ Shared Memory Segments --------
key        shmid      owner      perms      bytes      nattch     status


------ Semaphore Arrays --------
key        semid      owner      perms      nsems

root@children:/home/ubuntu/tmp<span class="token comment">#</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果在主机上执行 <code>ipcs -m</code> 和 <code>ipcs -s</code> 命令，是看不到共享内存和消息队列的，可以看到子进程的 IPC 资源是隔离的。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ ipcs <span class="token parameter variable">-q</span>

------ Message Queues --------
key        msqid      owner      perms      used-bytes   messages
0x000004d2 <span class="token number">0</span>          root       <span class="token number">666</span>        <span class="token number">0</span>            <span class="token number">0</span>


<span class="token comment"># ubuntu @ node1 in ~ [15:29:41]</span>
$ ipcs <span class="token parameter variable">-m</span>

------ Shared Memory Segments --------
key        shmid      owner      perms      bytes      nattch     status
0x00000000 <span class="token number">0</span>          root       <span class="token number">666</span>        <span class="token number">1024</span>       <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>也可以通过查看 <code>/proc/{pid}/ns/ipc</code> 文件检查 namespace 是否一致，可以看到子进程的 IPC namespace 和父进程的 IPC namespace 是不同的。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$  <span class="token function">sudo</span> <span class="token function">ls</span> <span class="token parameter variable">-al</span> /proc/2443935/ns/ipc
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">0</span> Feb  <span class="token number">6</span> <span class="token number">15</span>:36 /proc/2443935/ns/ipc -<span class="token operator">&gt;</span> <span class="token string">&#39;ipc:[4026531839]&#39;</span>

<span class="token comment"># ubuntu @ node1 in ~ [15:36:27]</span>
$  <span class="token function">sudo</span> <span class="token function">ls</span> <span class="token parameter variable">-al</span> /proc/2443936/ns/ipc
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">0</span> Feb  <span class="token number">6</span> <span class="token number">15</span>:36 /proc/2443936/ns/ipc -<span class="token operator">&gt;</span> <span class="token string">&#39;ipc:[4026532300]&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果把 <strong>CLONE_NEWIPC</strong> 参数去掉，则子进程可以看到父进程创建的共享内存和消息队列。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>$ sudo ./clone_uts
Parent process PID: 2443286
[Parent] Created shared memory ID: 1
[Parent] Created message queue ID: 0
Entering new shell (PID: 2443287)

------ Shared Memory Segments --------
key        shmid      owner      perms      bytes      nattch     status
0x00000000 0          root       666        1024       0
0x00000000 1          root       666        1024       0


------ Semaphore Arrays --------
key        semid      owner      perms      nsems

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查看 <code>/proc/{pid}/ns/ipc</code> 文件可以看到子进程的 IPC namespace 和父进程的 IPC namespace 是相同的。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">sudo</span> <span class="token function">ls</span> <span class="token parameter variable">-al</span> /proc/2443286/ns/ipc
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">0</span> Feb  <span class="token number">6</span> <span class="token number">15</span>:33 /proc/2443286/ns/ipc -<span class="token operator">&gt;</span> <span class="token string">&#39;ipc:[4026531839]&#39;</span>

$ <span class="token function">sudo</span> <span class="token function">ls</span> <span class="token parameter variable">-al</span> /proc/2443287/ns/ipc
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">0</span> Feb  <span class="token number">6</span> <span class="token number">15</span>:34 /proc/2443287/ns/ipc -<span class="token operator">&gt;</span> <span class="token string">&#39;ipc:[4026531839]&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="mount-namespace" tabindex="-1"><a class="header-anchor" href="#mount-namespace" aria-hidden="true">#</a> Mount namespace</h3><p>上面执行 PID namespace 隔离时，子进程中执行 <code>ps aux</code> 命令，依然可以看到主机所有的进程信息。这是因为这些命令是基于 <code>/proc</code> 文件系统读取的，PID、IPC 等 namespace 并不隔离文件系统，这需要通过 mount namespace 来实现。在通过 <strong>CLONE_NEWNS</strong> 创建新的 mount namespace 时，父进程会把自己的文件结构复制给子进程，早子进程中的所有 mount 操作都只影响自身的所在 namespace 的文件系统，不会对外界产生影响，从而实现非常严格的隔离。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>$ sudo ./clone_pid
Parent process PID: 2453554
Entering child shell (PID: 1)

# 被 namespace 隔离的子进程可以看到主机上的所有进程
root@children:/home/ubuntu/tmp# ps aux
USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root           1  0.0  0.3 168244 11676 ?        Ss    2024  28:19 /sbin/init
root           2  0.0  0.0      0     0 ?        S     2024   0:00 [kthreadd]
root           3  0.0  0.0      0     0 ?        I&lt;    2024   0:00 [rcu_gp]
root           4  0.0  0.0      0     0 ?        I&lt;    2024   0:00 [rcu_par_gp]
root           5  0.0  0.0      0     0 ?        I&lt;    2024   0:00 [slub_flushwq]
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们继续修改代码，创建子进程时，指定 CLONE_NEWNS 参数，并将 <code>proc</code> 挂载到子进程的 <code>/proc</code> 目录下。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_GNU_SOURCE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sched.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/msg.h&gt;</span></span>

<span class="token comment">// 分配子进程的栈空间（clone 需要手动提供栈）</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">STACK_SIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span>  </span><span class="token comment">// 1MB</span></span>
<span class="token keyword">static</span> <span class="token keyword">char</span> child_stack<span class="token punctuation">[</span>STACK_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 子进程执行的函数</span>
<span class="token keyword">int</span> <span class="token function">child_function</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Entering child shell (PID: %d)\n&quot;</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">sethostname</span><span class="token punctuation">(</span><span class="token string">&quot;children&quot;</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// CLONE_NEWNS 创建了独立的挂载空间，子进程看不到原来的 /proc，所以它必须手动重新挂载 proc。</span>
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">&quot;mount -t proc proc /proc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 运行 /bin/bash 交互式 shell</span>
    <span class="token function">execlp</span><span class="token punctuation">(</span><span class="token string">&quot;/bin/bash&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/bin/bash&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-i&quot;</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// execlp() 失败时返回错误</span>
    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;execlp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Parent process PID: %d\n&quot;</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建子进程，设置 CLONE_NEWIPC 并运行 bash</span>
    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">clone</span><span class="token punctuation">(</span>child_function<span class="token punctuation">,</span> child_stack <span class="token operator">+</span> STACK_SIZE<span class="token punctuation">,</span> CLONE_NEWUTS <span class="token operator">|</span> CLONE_NEWPID <span class="token operator">|</span> CLONE_NEWNS <span class="token operator">|</span> SIGCHLD<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;clone&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 等待子进程结束</span>
    <span class="token function">waitpid</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Child process exited\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>再次运行程序，可以看到子进程自己看到的 PID 为 1，并且执行 ps、top 命令时只能看到自己 namespace 下的进程。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">sudo</span> ./clone_newns
Parent process PID: <span class="token number">2458440</span>
Entering child shell <span class="token punctuation">(</span>PID: <span class="token number">1</span><span class="token punctuation">)</span>
root@children:/home/ubuntu/tmp<span class="token comment"># ps aux</span>
<span class="token environment constant">USER</span>         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root           <span class="token number">1</span>  <span class="token number">0.0</span>  <span class="token number">0.1</span>   <span class="token number">7636</span>  <span class="token number">4232</span> pts/3    S    <span class="token number">15</span>:54   <span class="token number">0</span>:00 /bin/bash <span class="token parameter variable">-i</span>
root           <span class="token number">9</span>  <span class="token number">0.0</span>  <span class="token number">0.0</span>  <span class="token number">10072</span>  <span class="token number">1544</span> pts/3    R+   <span class="token number">15</span>:54   <span class="token number">0</span>:00 <span class="token function">ps</span> aux

root@children:/home/ubuntu/tmp<span class="token comment"># top</span>
<span class="token function">top</span> - <span class="token number">15</span>:55:00 up <span class="token number">66</span> days,  <span class="token number">3</span>:15,  <span class="token number">5</span> users,  load average: <span class="token number">0.00</span>, <span class="token number">0.04</span>, <span class="token number">0.01</span>
Tasks:   <span class="token number">2</span> total,   <span class="token number">1</span> running,   <span class="token number">1</span> sleeping,   <span class="token number">0</span> stopped,   <span class="token number">0</span> zombie
%Cpu<span class="token punctuation">(</span>s<span class="token punctuation">)</span>:  <span class="token number">0.3</span> us,  <span class="token number">0.3</span> sy,  <span class="token number">0.0</span> ni, <span class="token number">99.3</span> id,  <span class="token number">0.0</span> wa,  <span class="token number">0.0</span> hi,  <span class="token number">0.0</span> si,  <span class="token number">0.0</span> st
MiB Mem <span class="token builtin class-name">:</span>   <span class="token number">3335.9</span> total,    <span class="token number">208.7</span> free,    <span class="token number">447.9</span> used,   <span class="token number">2679.3</span> buff/cache
MiB Swap:      <span class="token number">0.0</span> total,      <span class="token number">0.0</span> free,      <span class="token number">0.0</span> used.   <span class="token number">2596.6</span> avail Mem

    PID <span class="token environment constant">USER</span>      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND
      <span class="token number">1</span> root      <span class="token number">20</span>   <span class="token number">0</span>    <span class="token number">7636</span>   <span class="token number">4344</span>   <span class="token number">3736</span> S   <span class="token number">0.0</span>   <span class="token number">0.1</span>   <span class="token number">0</span>:00.00 <span class="token function">bash</span>
     <span class="token number">11</span> root      <span class="token number">20</span>   <span class="token number">0</span>   <span class="token number">10352</span>   <span class="token number">4020</span>   <span class="token number">3460</span> R   <span class="token number">0.0</span>   <span class="token number">0.1</span>   <span class="token number">0</span>:00.00 <span class="token function">top</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="user-namespace" tabindex="-1"><a class="header-anchor" href="#user-namespace" aria-hidden="true">#</a> User namespace</h3><p>User namespace 主要隔离了用户和用户组，每个 namespace 内的用户和用户组都是从 0 开始，并且相互隔离。这在容器中非常有用，比如容器中的进程可能需要 root 权限，但如果容器直接使用了主机的 root 用户会带来安全隐患，我们可以通过 User namespace 来隔离用户和用户组，将容器中的 root 用户映射到主机的某个用户，从而实现安全的隔离。</p><p>Usernamespace 使用 CLONE_NEWUSER 参数创建，我们修改代码，在执行 clone 创建子进程时，指定 CLONE_NEWUSER 参数。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>
<span class="token comment">// 分配子进程的栈空间（clone 需要手动提供栈）</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">STACK_SIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span>  </span><span class="token comment">// 1MB</span></span>
<span class="token keyword">static</span> <span class="token keyword">char</span> child_stack<span class="token punctuation">[</span>STACK_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 子进程执行的函数</span>
<span class="token keyword">int</span> <span class="token function">child_function</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Entering child shell (PID: %d)\n&quot;</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">sethostname</span><span class="token punctuation">(</span><span class="token string">&quot;children&quot;</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 打印当前用户和用户组</span>
    <span class="token keyword">int</span> uid <span class="token operator">=</span> <span class="token function">getuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> gid <span class="token operator">=</span> <span class="token function">getgid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;User ID: %d, Group ID: %d\n&quot;</span><span class="token punctuation">,</span> uid<span class="token punctuation">,</span> gid<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 运行 /bin/bash 交互式 shell</span>
    <span class="token function">execlp</span><span class="token punctuation">(</span><span class="token string">&quot;/bin/bash&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/bin/bash&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-i&quot;</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// execlp() 失败时返回错误</span>
    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;execlp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Parent process PID: %d\n&quot;</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建子进程，设置 CLONE_NEWUSER 并运行 bash</span>
    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">clone</span><span class="token punctuation">(</span>child_function<span class="token punctuation">,</span> child_stack <span class="token operator">+</span> STACK_SIZE<span class="token punctuation">,</span> CLONE_NEWUTS  <span class="token operator">|</span>  CLONE_NEWUSER<span class="token operator">|</span>SIGCHLD<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 代码省略...</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>编译执行代码，可以看到子进程的 UID 和 GID 都是 65534，这是 User namespace 的默认用户和用户组。在 <code>/proc/sys/kernel/overflowuid</code> 和 <code>/proc/sys/kernel/overflowgid</code> 文件中定义，如果新的 usernamespace 中的 UID、GID 没有明确映射到主机的用户和用户组，则使用 overflowuid 和 overflowgid 作为默认用户和用户组。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>Parent process PID: <span class="token number">2736120</span>
Entering child shell <span class="token punctuation">(</span>PID: <span class="token number">2736121</span><span class="token punctuation">)</span>
User ID: <span class="token number">65534</span>, Group ID: <span class="token number">65534</span>
nobody@children:/home/ubuntu/tmp$ <span class="token function">id</span>
<span class="token assign-left variable">uid</span><span class="token operator">=</span><span class="token number">65534</span><span class="token punctuation">(</span>nobody<span class="token punctuation">)</span> <span class="token assign-left variable">gid</span><span class="token operator">=</span><span class="token number">65534</span><span class="token punctuation">(</span>nogroup<span class="token punctuation">)</span> <span class="token assign-left variable">groups</span><span class="token operator">=</span><span class="token number">65534</span><span class="token punctuation">(</span>nogroup<span class="token punctuation">)</span>

$ <span class="token function">cat</span> /proc/sys/kernel/overflowuid
<span class="token number">65534</span>

$ <span class="token function">cat</span> /proc/sys/kernel/overflowgid
<span class="token number">65534</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果我们想把容器中的 uid、gid 映射到主机的某个用户和用户组，需要修改 <code>/proc/{pid}/uid_map</code> 和 <code>/proc/{gid}/gid_map</code> 两个文件进行映射。格式为：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>{container_uid} {host_uid} {length}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>三个参数分别表示：</p><ul><li>容器中的 uid 或 gid</li><li>映射到主机中的 uid、gid</li><li>映射范围，一般为 1，表示一一对应</li></ul><p>这两个文件的写入权限需要满足以下条件：</p><ul><li>写文件的进程必须有这个 namespace 的的 <strong>CAP_SETUID</strong> 和 <strong>CAP_SETGID</strong> 权限，参考 <a href="https://man7.org/linux/man-pages/man7/capabilities.7.html" target="_blank" rel="noopener noreferrer">Linux Capabilities<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li>写文件进程必须是此 namespace 的父进程或者子进程</li></ul><p>比如我们在 Ubuntu 系统中运行的代码，想把 namespace 内部的 root（uid=0）映射到主机中的 ubuntu（uid=1000），用户，可以修改 <code>/proc/{pid}/uid_map</code> 文件，添加如下内容：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>0 1000 1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>下面是代码示例：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">STACK_SIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span>  </span><span class="token comment">// 1MB</span></span>
<span class="token keyword">static</span> <span class="token keyword">char</span> child_stack<span class="token punctuation">[</span>STACK_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 子进程执行的函数</span>
<span class="token keyword">int</span> <span class="token function">child_function</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Child process (PID: %d)\n&quot;</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 映射子进程的 UID 和 GID 到宿主机的普通用户 ID（假设是 1000）</span>
    FILE <span class="token operator">*</span>uid_map <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">&quot;/proc/self/uid_map&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;w&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>uid_map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span>uid_map<span class="token punctuation">,</span> <span class="token string">&quot;0 1000 1\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 子进程的 UID 映射到宿主机 UID 1000</span>
        <span class="token function">fclose</span><span class="token punctuation">(</span>uid_map<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;fopen uid_map&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    FILE <span class="token operator">*</span>setgroups <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">&quot;/proc/self/setgroups&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;w&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>setgroups<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span>setgroups<span class="token punctuation">,</span> <span class="token string">&quot;deny\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 禁止组映射</span>
        <span class="token function">fclose</span><span class="token punctuation">(</span>setgroups<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;fopen setgroups&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    FILE <span class="token operator">*</span>gid_map <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">&quot;/proc/self/gid_map&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;w&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>gid_map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span>gid_map<span class="token punctuation">,</span> <span class="token string">&quot;0 1000 1\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 子进程的 GID 映射到宿主机 GID 1000</span>
        <span class="token function">fclose</span><span class="token punctuation">(</span>gid_map<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;fopen gid_map&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 打印 UID 和 GID</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;User ID: %d, Group ID: %d\n&quot;</span><span class="token punctuation">,</span> <span class="token function">getuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getgid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">execlp</span><span class="token punctuation">(</span><span class="token string">&quot;/bin/bash&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/bin/bash&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-i&quot;</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// execlp() 失败时返回错误</span>
    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;execlp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Parent process (PID: %d)\n&quot;</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建 User Namespace 并执行子进程</span>
    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">clone</span><span class="token punctuation">(</span>child_function<span class="token punctuation">,</span> child_stack <span class="token operator">+</span> STACK_SIZE<span class="token punctuation">,</span> CLONE_NEWUSER <span class="token operator">|</span> SIGCHLD<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;clone&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 等待子进程结束</span>
    <span class="token function">waitpid</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>再次运行代码查看子进程的 UID 和 GID，可以看到其 ID 为 0，并且 /proc/self/uid_map 和 /proc/self/gid_map 文件中已经映射成功。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ ./clone_user
Parent process <span class="token punctuation">(</span>PID: <span class="token number">2816659</span><span class="token punctuation">)</span>
Child process <span class="token punctuation">(</span>PID: <span class="token number">2816660</span><span class="token punctuation">)</span>
User ID: <span class="token number">0</span>, Group ID: <span class="token number">0</span>

root@node1:~/tmp<span class="token comment"># id</span>
<span class="token assign-left variable">uid</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span> <span class="token assign-left variable">gid</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span> <span class="token assign-left variable">groups</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span>,65534<span class="token punctuation">(</span>nogroup<span class="token punctuation">)</span>


$ <span class="token function">cat</span> /proc/2816660/gid_map
         <span class="token number">0</span>       <span class="token number">1000</span>          <span class="token number">1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>映射成功后，虽然容器中是 root 用户，但容器中执行的命令是以 ubuntu 用户执行的，容器的安全性得到了提升。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>ubuntu   2816659  0.0  0.0   3800  1044 pts/1    S    14:48   0:00 ./clone_user
ubuntu   2816660  0.0  0.1   8664  5364 pts/1    S+   14:48   0:00 /bin/bash -i
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="network-namespace" tabindex="-1"><a class="header-anchor" href="#network-namespace" aria-hidden="true">#</a> Network namespace</h3><p>Network namespace 用于网络隔离，每个 namespace 都有自己的网络设备、IP 地址、路由表、防火墙规则等。这里我们用 ip 命令来做测试。</p><p>Docker 容器都有自己的网络 namespace，默认使用网桥进行容器间的通信，示例如下：</p><p><img src="https://pub-08b57ed9c8ce4fadab4077a9d577e857.r2.dev/container-network.png" alt=""></p><p>Docker 有自己的私有网段 172.18.0.0/16，启动时会创建一个名为 docker0 的 bridge 设备，默认地址为 172.17.0.1/16，每个容器有自己的 network namespace，图中两个容器有自己的 network namespace，IP 地址分别为 172.18.0.2 和 172.18.0.3，namespace 和 docker0 通过 veth 设备连接，加上路由表和 iptables 规则，从而实现容器间的通信和外网访问。</p><p>我们可以用下面一组命令来 DIY namespace 的网络，模拟容器的网络隔离和通信。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 创建一个 bridge 设备 drybr0 docker0</span>
$ <span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token function">add</span> name drybr0 <span class="token builtin class-name">type</span> bridge
$ <span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> dev drbr0 <span class="token builtin class-name">type</span> bridge stp_state <span class="token number">0</span>

<span class="token comment"># 为 drybr0 设备设置 IP 地址</span>
$ <span class="token function">sudo</span> <span class="token function">ip</span> addr <span class="token function">add</span> <span class="token number">172.17</span>.0.1/16 dev drybr0

<span class="token comment"># 创建两个 namespace</span>
$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token function">add</span> dryns1
$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token function">add</span> dryns2

<span class="token comment"># 激活两个 namespace 的回环接口</span>
$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> dryns1 <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> lo up
$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> dryns2 <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> lo up

<span class="token comment"># 创建两对 veth 对</span>
$ <span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token function">add</span> dryveth0 <span class="token builtin class-name">type</span> veth peer name drybr0.1
$ <span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token function">add</span> dryveth1 <span class="token builtin class-name">type</span> veth peer name drybr0.2


<span class="token comment"># 将 veth 对一头加到 namespace</span>
$ <span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> dryveth0 netns dryns1
$ <span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> dryveth1 netns dryns2

<span class="token comment"># 修改 namespace 中的 veth 设备名称为 eth0</span>
$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> dryns1 <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> dryveth0 name eth0
$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> dryns2 <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> dryveth1 name eth0

<span class="token comment"># 为 namespace 中的 eth0 设备设置 IP 地址并激活</span>
$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> dryns1 <span class="token function">ip</span> addr <span class="token function">add</span> <span class="token number">172.17</span>.0.2/16 dev eth0
$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> dryns2 <span class="token function">ip</span> addr <span class="token function">add</span> <span class="token number">172.17</span>.0.3/16 dev eth0

$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> dryns1 <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> eth0 up
$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> dryns2 <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> eth0 up

<span class="token comment"># veth 连接到 drybr0，启动 veth 和 bridge</span>
$ <span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> drybr0 up
$ <span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> drybr0.1 master drybr0
$ <span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> drybr0.2 master drybr0
$ <span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> drybr0.1 up
$ <span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> drybr0.2 up

<span class="token comment"># 为 namespace 添加路由规则，使其可以访问到外部</span>
<span class="token comment"># 默认传输全部走 drybr0</span>
$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> dryns1 <span class="token function">ip</span> route <span class="token function">add</span> default via <span class="token number">172.17</span>.0.1
$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> dryns2 <span class="token function">ip</span> route <span class="token function">add</span> default via <span class="token number">172.17</span>.0.1

<span class="token comment"># 在 dryns1 中 ping dryns2，此时可以看到两个 namespace 之间可以互相通信</span>
$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> dryns1 <span class="token function">ping</span> <span class="token number">172.17</span>.0.3
PING <span class="token number">172.17</span>.0.3 <span class="token punctuation">(</span><span class="token number">172.17</span>.0.3<span class="token punctuation">)</span> <span class="token number">56</span><span class="token punctuation">(</span><span class="token number">84</span><span class="token punctuation">)</span> bytes of data.
<span class="token number">64</span> bytes from <span class="token number">172.17</span>.0.3: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.098</span> ms
<span class="token number">64</span> bytes from <span class="token number">172.17</span>.0.3: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.052</span> ms

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上述代码模拟了两个容器之间的通信模式，现在两个 namespace 之间是互通的，但如果想访问外界，目前还做不到，原因是 namespace 中的请求会走到 drybr0 设备。drybr0 目前会将同网段的数据通过 veth 对发送到对应的 namespace 中，但对访问外部网络的请求，drybr0 没办法转发出去。</p><p>查看主机路由信息：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 查看主机路由信息，drybr0 应该将数据路由到 eth0</span>
$ <span class="token function">ip</span> route
default via <span class="token number">172.19</span>.0.1 dev eth0 proto dhcp src <span class="token number">172.19</span>.0.12 metric <span class="token number">100</span>
<span class="token number">172.17</span>.0.0/16 dev drybr0 proto kernel scope <span class="token function">link</span> src <span class="token number">172.17</span>.0.1
<span class="token number">172.19</span>.0.0/20 dev eth0 proto kernel scope <span class="token function">link</span> src <span class="token number">172.19</span>.0.12 metric <span class="token number">100</span>
<span class="token number">172.19</span>.0.1 dev eth0 proto dhcp scope <span class="token function">link</span> src <span class="token number">172.19</span>.0.12 metric <span class="token number">100</span>
<span class="token number">183.60</span>.82.98 via <span class="token number">172.19</span>.0.1 dev eth0 proto dhcp src <span class="token number">172.19</span>.0.12 metric <span class="token number">100</span>
<span class="token number">183.60</span>.83.19 via <span class="token number">172.19</span>.0.1 dev eth0 proto dhcp src <span class="token number">172.19</span>.0.12 metric <span class="token number">100</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>默认情况下，主机会将 src 为 172.19.0.12 的数据包用 eth0 设备转发到 172.19.0.1 设备。而 drybr0 发出的数据包其网络地址为 172.17.0.0/16，所以无法通过 eth0 设备转发出去。我们需要设置 NAT 规则，将 172.17.0.0/16 的数据包源地址替换为 eth0 的地址，这样就可以通过 eth0 设备转发出去。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 在 dryns1 中访问百度会超时</span>
$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> dryns1  <span class="token function">wget</span> https://103.235.46.96 --no-check-certificate
--2025-02-11 <span class="token number">15</span>:30:33--  https://103.235.46.96/
Connecting to <span class="token number">103.235</span>.46.96:443<span class="token punctuation">..</span>.



<span class="token comment"># 开启 IP 转发</span>
$ <span class="token function">sudo</span> <span class="token function">sysctl</span> <span class="token parameter variable">-w</span> <span class="token assign-left variable">net.ipv4.ip_forward</span><span class="token operator">=</span><span class="token number">1</span>
net.ipv4.ip_forward <span class="token operator">=</span> <span class="token number">1</span>

<span class="token comment"># 配置 iptables 规则，将 eth0 发送的源地址为 172.17.0.0/16 的数据包进行 SNAT 操作，将其替换为 eth0 的地址</span>
$ <span class="token function">sudo</span> iptables <span class="token parameter variable">-t</span> nat <span class="token parameter variable">-A</span> POSTROUTING <span class="token parameter variable">-s</span> <span class="token number">172.17</span>.0.0/16 <span class="token parameter variable">-o</span> eth0 <span class="token parameter variable">-j</span> MASQUERADE

<span class="token comment"># 再次访问百度，可以看到成功访问</span>
$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> dryns1  <span class="token function">wget</span> https://103.235.46.96 --no-check-certificate
--2025-02-11 <span class="token number">15</span>:46:43--  https://103.235.46.96/
Connecting to <span class="token number">103.235</span>.46.96:443<span class="token punctuation">..</span>. connected.
    WARNING: certificate common name ‘baidu.com’ doesn&#39;t match requested <span class="token function">host</span> name ‘103.235.46.96’.
HTTP request sent, awaiting response<span class="token punctuation">..</span>. <span class="token number">200</span> OK
Length: <span class="token number">2443</span> <span class="token punctuation">(</span><span class="token number">2</span>.4K<span class="token punctuation">)</span> <span class="token punctuation">[</span>text/html<span class="token punctuation">]</span>
Saving to: ‘index.html.1’

index.html.1                                                <span class="token number">100</span>%<span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">]</span>   <span class="token number">2</span>.39K  --.-KB/s    <span class="token keyword">in</span> 0s

<span class="token number">2025</span>-02-11 <span class="token number">15</span>:46:43 <span class="token punctuation">(</span><span class="token number">33.3</span> MB/s<span class="token punctuation">)</span> - ‘index.html.1’ saved <span class="token punctuation">[</span><span class="token number">2443</span>/2443<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面命令成功访问了百度，但我们是用 IP 访问的，如果用域名访问会报错。这里要为 namespace 配置 DNS 解析，需要在 /etc/netns/{namespace_name} 目录下创建 resolv.conf 文件。配置完成后，再次访问域名，可以看到成功访问。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 通过域名访问，依然报错</span>
$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> dryns1 <span class="token function">ping</span> www.baidu.com
ping: www.baidu.com: Temporary failure <span class="token keyword">in</span> name resolution


<span class="token comment"># 配置 DNS 解析</span>
$ <span class="token function">sudo</span> <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/netns/dryns1
$ <span class="token function">sudo</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;nameserver 8.8.8.8&quot;</span> <span class="token operator">&gt;</span> /etc/netns/dryns1/resolv.conf

$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> dryns1 <span class="token function">ping</span> www.baidu.com
PING www.wshifen.com <span class="token punctuation">(</span><span class="token number">103.235</span>.46.96<span class="token punctuation">)</span> <span class="token number">56</span><span class="token punctuation">(</span><span class="token number">84</span><span class="token punctuation">)</span> bytes of data.
<span class="token number">64</span> bytes from <span class="token number">103.235</span>.46.96 <span class="token punctuation">(</span><span class="token number">103.235</span>.46.96<span class="token punctuation">)</span>: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">54</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">1.89</span> ms
<span class="token number">64</span> bytes from <span class="token number">103.235</span>.46.96 <span class="token punctuation">(</span><span class="token number">103.235</span>.46.96<span class="token punctuation">)</span>: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">54</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">1.86</span> ms
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以上就是 docker 网络的基本原理了，觉得难理解可以参考这个<a href="https://labs.iximiuz.com/tutorials/container-networking-from-scratch" target="_blank" rel="noopener noreferrer">交互式教程：a Docker Bridge Network From Scratch<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>，每次执行命令都会以图表的形式展示网络结构的变化。</p><p>具体到 Docker 的实现，它自己实现了类似 ip 命令的工具；对于域名解析，它没有采用 上述 resolv.conf 文件的方式，而是用了 Mount Namespace 的方式实现。</p><h3 id="cgroup-namespace" tabindex="-1"><a class="header-anchor" href="#cgroup-namespace" aria-hidden="true">#</a> Cgroup namespace</h3><p>关于 Cgroup namespace 的介绍我们放到下一篇 cgroup 文章中专门介绍，这里不做赘述。</p><h3 id="time-namespace" tabindex="-1"><a class="header-anchor" href="#time-namespace" aria-hidden="true">#</a> Time namespace</h3><p>这是 Linux 5.6 版本引入的一种 namespace，用于隔离系统时间。服务器本身有三种时间：</p><ul><li><strong>CLOUD_REALTIME</strong>：实时时间，就是我们日常使用的时间，系统的实时时间一般受 NTP 等服务的影响，可以用 <code>date</code> 命令查看</li></ul><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>$ date
Sun Mar  2 11:17:51 AM CST 2025
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p><strong>CLOCK_MONOTONIC</strong>：单调时间，从过去某个时间点开始的单调递增的时间，这是计算时间差最好的方式。</p></li><li><p><strong>CLOCK_BOOTTIME</strong>：系统启动到现在的时间，包括休眠时间，可以用 <code>uptime</code> 命令或者 <code>/proc/uptime</code> 文件查看。</p></li></ul><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>$ uptime
11:17:51 up 1 day, 11:17,  1 user,  load average: 0.00, 0.01, 0.05
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>$ cat /proc/uptime
1714635471.00 1714635471.00
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>Time namespace 支持后两种时间的隔离，目前只能通过 unshare 命令来创建 Time namespace，然后调用 setns 命令将进程加入到 Time namespace 中。具体的偏移量有在 /proc/{pid}/timens_offsets 文件中设置，格式为：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>{clock_id} {offset_sec} {offset_nsec} 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>clock_id：时间类型，可以是 CLOCK_MONOTONIC 或者 CLOCK_BOOTTIME</li><li>offset_sec：秒偏移量，可以为负数。</li><li>offset_nsec：纳秒偏移量，不可以为负数。</li></ul><p>默认偏移都是 0，表示没有偏移。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>cat /proc/self/timens_offsets
monotonic           0         0
boottime            0         0

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果我们希望将时间偏移提前 7 天，可以做如下修改：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>monotonic -604800 0
boottime -604800 0
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></div><!--[--><!--[--><div class="page-info" data-v-efed79f6><div class="star" data-v-efed79f6><span data-v-efed79f6><a data-icon="octicon-star" href="https://github.com/zouyingjie/cloudnative-notes">Star 关注</a></span></div><div class="last-updated" data-v-efed79f6><span class="prefix" data-v-efed79f6>总字数:</span><span class="words" data-v-efed79f6>6439</span><span class="prefix" data-v-efed79f6>字</span></div></div><div id="comment" class="giscus-wrapper input-top layout-comment" style="display:block;" data-v-efed79f6><div class="loading-icon-wrapper" style="display:flex;align-items:center;justify-content:center;height:96px"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div><!--]--><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="external-link meta-item-label" href="https://github.com/zouyingjie/cloudnativenotes/edit/main/cloudnative/container/docker-namespace.md" rel="noopener noreferrer" target="_blank" aria-label="在GitHub中编辑"><!--[--><!--]--> 在GitHub中编辑 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: yingjiezou1@gmail.com">zouyingjie</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><!----><span class="next"><a href="/cloudnativenotes/cloudnative/container/docker-cgroups.html" class="" aria-label="容器基础技术：cgroups"><!--[--><!--]--> 容器基础技术：cgroups <!--[--><!--]--></a></span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/cloudnativenotes/assets/app-C-eiXR-Q.js" defer></script>
  </body>
</html>
